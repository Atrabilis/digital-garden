<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumberjack | Mi Digital Garden</title>
  <meta name="description" content="Notes on my studies and experiences in the engineering and technology field" />
  <link rel="stylesheet" href="/digital-garden/assets/css/style.css">
</head>

<body>
  <aside class="sidebar">
    <h1 class="site-title">
      <a href="/digital-garden/" class="site-title__link">Mi Digital Garden</a>
    </h1>
    <p class="site-desc">Notes on my studies and experiences in the engineering and technology field</p>

    <nav class="side-nav" aria-label="Colecciones">
      <h2 class="side-nav__heading">Collections</h2>
      <ul class="side-nav__list"><li class="collection">
            <details class="collection__details" open>
              <summary class="collection__summary">
                <span class="collection__name">Go</span>
                <span class="collection__count">(5)</span>
              </summary>
              <ul class="doc-list">
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/go/clickhouse/">Clickhouse</a>
                  </li>
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/go/influxdb2/">Influxdb2</a>
                  </li>
                  <li class="doc-list__item">
                    <a class="doc-list__link is-active"
                       href="/digital-garden/go/lumberjack/">Lumberjack</a>
                  </li>
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/go/os/">Os</a>
                  </li>
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/go/slog/">Slog</a>
                  </li>
              </ul>
            </details>
          </li><li class="collection">
            <details class="collection__details" >
              <summary class="collection__summary">
                <span class="collection__name">good-practices</span>
                <span class="collection__count">(1)</span>
              </summary>
              <ul class="doc-list">
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/good-practices/logging-system/">Logging system</a>
                  </li>
              </ul>
            </details>
          </li><li class="collection">
            <details class="collection__details" >
              <summary class="collection__summary">
                <span class="collection__name">Jekyll</span>
                <span class="collection__count">(1)</span>
              </summary>
              <ul class="doc-list">
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/jekyll/config-yml/">Config.yml</a>
                  </li>
              </ul>
            </details>
          </li><li class="collection">
            <details class="collection__details" >
              <summary class="collection__summary">
                <span class="collection__name">Networking</span>
                <span class="collection__count">(1)</span>
              </summary>
              <ul class="doc-list">
                  <li class="doc-list__item">
                    <a class="doc-list__link"
                       href="/digital-garden/networking/wireguard/">Wireguard</a>
                  </li>
              </ul>
            </details>
          </li>
      </ul>
    </nav>
    <div class="sidebar-resizer"></div>
  </aside>

  <main class="content" id="content">
    <p>#notes on Lumberjack</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"log/slog"</span>
	<span class="s">"os"</span>
	<span class="s">"time"</span>

	<span class="s">"gopkg.in/natefinch/lumberjack.v2"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// STEP 1. Configure a lumberjack rotating writer</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// lumberjack.Logger implements io.Writer with rotation logic.</span>
	<span class="c">// Fields:</span>
	<span class="c">//   Filename   -&gt; path to the "current" active log file</span>
	<span class="c">//   MaxSize    -&gt; maximum size in MB before rotating (0 = no limit)</span>
	<span class="c">//   MaxAge     -&gt; maximum number of days to keep old log files (0 = forever)</span>
	<span class="c">//   MaxBackups -&gt; maximum number of old log files to retain (0 = keep all)</span>
	<span class="c">//   LocalTime  -&gt; use local time in rotated file names (false = UTC)</span>
	<span class="c">//   Compress   -&gt; gzip old log files (true) or keep plain (false)</span>
	<span class="c">//</span>
	<span class="c">// Important:</span>
	<span class="c">// - Rotation happens *on write*, not in a background goroutine.</span>
	<span class="c">// - app.log will always be the active file; older ones will be renamed.</span>
	<span class="c">// - Old files will be deleted/compressed depending on MaxBackups/MaxAge.</span>
	<span class="n">lj</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">lumberjack</span><span class="o">.</span><span class="n">Logger</span><span class="p">{</span>
		<span class="n">Filename</span><span class="o">:</span>   <span class="s">"app.json"</span><span class="p">,</span> <span class="c">// "active" log file (always written to)</span>
		<span class="n">MaxSize</span><span class="o">:</span>    <span class="m">1</span><span class="p">,</span>          <span class="c">// rotate after 1 MB (for testing)</span>
		<span class="n">MaxBackups</span><span class="o">:</span> <span class="m">3</span><span class="p">,</span>          <span class="c">// keep at most 3 old files</span>
		<span class="n">MaxAge</span><span class="o">:</span>     <span class="m">7</span><span class="p">,</span>          <span class="c">// keep rotated files for 7 days</span>
		<span class="n">Compress</span><span class="o">:</span>   <span class="no">true</span><span class="p">,</span>       <span class="c">// compress old files with gzip</span>
	<span class="p">}</span>

	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// STEP 2. Create a slog Handler that writes JSON logs to lumberjack</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// slog.NewJSONHandler takes any io.Writer. Because lumberjack.Logger</span>
	<span class="c">// implements io.Writer, it can be used directly here.</span>
	<span class="c">//</span>
	<span class="c">// HandlerOptions:</span>
	<span class="c">//   Level -&gt; minimum log level to write (default = INFO)</span>
	<span class="c">//   AddSource -&gt; if true, include source file:line (costs performance)</span>
	<span class="n">handler</span> <span class="o">:=</span> <span class="n">slog</span><span class="o">.</span><span class="n">NewJSONHandler</span><span class="p">(</span><span class="n">lj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slog</span><span class="o">.</span><span class="n">HandlerOptions</span><span class="p">{</span>
		<span class="n">Level</span><span class="o">:</span> <span class="n">slog</span><span class="o">.</span><span class="n">LevelInfo</span><span class="p">,</span> <span class="c">// only INFO, WARN, ERROR logs will be written</span>
	<span class="p">})</span>

	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// STEP 3. Create a Logger from the handler</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// slog.New(handler) returns a Logger. You can also attach fixed</span>
	<span class="c">// attributes using .With(...). Those attributes will appear in every log.</span>
	<span class="n">logger</span> <span class="o">:=</span> <span class="n">slog</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">.</span><span class="n">With</span><span class="p">(</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"service"</span><span class="p">,</span> <span class="s">"app"</span><span class="p">),</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"env"</span><span class="p">,</span> <span class="s">"dev"</span><span class="p">),</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"version"</span><span class="p">,</span> <span class="s">"1.0.0"</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// STEP 4. Write some logs</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// slog levels: Debug, Info, Warn, Error</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"server started"</span><span class="p">,</span> <span class="s">"port"</span><span class="p">,</span> <span class="m">8080</span><span class="p">)</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="s">"high latency"</span><span class="p">,</span> <span class="s">"path"</span><span class="p">,</span> <span class="s">"/users"</span><span class="p">,</span> <span class="s">"duration_ms"</span><span class="p">,</span> <span class="m">950</span><span class="p">)</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"db timeout"</span><span class="p">,</span> <span class="s">"operation"</span><span class="p">,</span> <span class="s">"SELECT"</span><span class="p">,</span> <span class="s">"retryable"</span><span class="p">,</span> <span class="no">true</span><span class="p">)</span>

	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// STEP 5. Force many logs to exceed 1 MB and trigger rotation</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// Once app.json exceeds 1 MB, lumberjack will:</span>
	<span class="c">//   - Rename app.json -&gt; app-&lt;timestamp&gt;.log.gz</span>
	<span class="c">//   - Create a new empty app.json</span>
	<span class="c">//   - Enforce MaxBackups (3) and MaxAge (7 days)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"looping"</span><span class="p">,</span> <span class="s">"iteration"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">"ts"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// RESULT:</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// In the directory you will see:</span>
	<span class="c">//   app.json                        -&gt; active log file</span>
	<span class="c">//   app-2025-09-04T05-35-15.log.gz  -&gt; old compressed copy</span>
	<span class="c">//   app-2025-09-04T05-35-30.log.gz  -&gt; next rotated copy</span>
	<span class="c">//   ...</span>
	<span class="c">// At most 3 rotated files (MaxBackups=3) will be kept, and older than</span>
	<span class="c">// 7 days (MaxAge=7) will be deleted.</span>
	<span class="c">//</span>
	<span class="c">// Each line inside the logs is JSON, e.g.:</span>
	<span class="c">// {</span>
	<span class="c">//   "time":"2025-09-04T05:35:15Z",</span>
	<span class="c">//   "level":"INFO",</span>
	<span class="c">//   "msg":"server started",</span>
	<span class="c">//   "service":"app",</span>
	<span class="c">//   "env":"dev",</span>
	<span class="c">//   "version":"1.0.0",</span>
	<span class="c">//   "port":8080</span>
	<span class="c">// }</span>
	<span class="c">//</span>
	<span class="c">// This makes logs structured and ready for ingestion in ELK, Loki, etc.</span>
	<span class="c">//</span>
	<span class="c">// ----------------------------------------------------------</span>
	<span class="c">// END</span>
<span class="p">}</span>
</code></pre></div></div>

  </main>
</body>

<script src="/digital-garden/assets/js/sidebar-resize.js"></script>

</html>
